<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.146.5"><meta name=viewport content="width=device-width,initial-scale=1"><title>Avoid Data Loss When Updating the AzureRM Terraform Provider &#183; by Alex Code blog</title>
<meta name=keywords content="terraform azurerm azure storage account data-loss update"><meta name=description content="How not to lose the data in storage account container by updating the terraform template for azurerm 4.9.0"><link type=text/css rel=stylesheet href=https://blog.byalex.dev/css/print.css media=print><link type=text/css rel=stylesheet href=https://blog.byalex.dev/css/poole.css><link type=text/css rel=stylesheet href=https://blog.byalex.dev/css/syntax.css><link type=text/css rel=stylesheet href=https://blog.byalex.dev/css/hyde.css><link type=text/css rel=stylesheet href=https://blog.byalex.dev/css/vs_theme_style.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png></head><body><aside class=sidebar><div class=container><div class=sidebar-about><a href=https://blog.byalex.dev/><h1>by Alex Code blog</h1></a><p class=lead>Smart thoughts... and not very smart too!</p></div><nav><ul class=sidebar-nav><li><a href=https://blog.byalex.dev/>Home</a></li><li><a href=https://blog.byalex.dev/article>Articles</a></li><li><a href=https://github.com/lanubisl target=_blank>Github</a></li><li><a href=https://www.linkedin.com/in/panfilenok target=_blank>LinkedIn</a></li></ul></nav><p>&copy; 2025. All rights reserved.</p></div></aside><main class="content container"><div class=post><h1>Avoid Data Loss When Updating the AzureRM Terraform Provider</h1><time datetime=2024-11-25T21:19:21Z class=post-date>Mon, Nov 25, 2024</time><p><img src=/images/terraform-4.9.0-azurerm-storage-container-update/title.webp alt></p><p>With the release of <a href=https://registry.terraform.io/providers/hashicorp/azurerm/4.9.0/docs/resources/storage_container target=_blank rel=noopener>AzureRM provider 4.9.0</a>, the azurerm_storage_container resource deprecates the storage_account_name argument in favor of the storage_account_id argument. Updating your Terraform template to use storage_account_id directly will force Terraform to recreate the storage container, leading to <strong>potential data loss</strong>.</p><p>Here’s a step-by-step guide to safely update your configuration without losing data in the storage container.</p><h2 id=step-1-update-azurerm-to-version-490>Step 1: Update AzureRM to Version 4.9.0</h2><p>The storage_account_id argument is introduced in version 4.9.0, while storage_account_name is still supported but marked as deprecated. Ensure you&rsquo;re using this version to perform the migration smoothly without data loss.</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#8839ef>terraform</span> {
</span></span><span style=display:flex><span>  <span style=color:#8839ef>required_providers</span> {
</span></span><span style=display:flex><span>    azurerm <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span>      source  <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#40a02b>&#34;hashicorp/azurerm&#34;</span>
</span></span><span style=display:flex><span>      version <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#40a02b>&#34;~&gt; 4.9.0&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=step-2-ensure-terraform-plan-shows-no-changes>Step 2: Ensure Terraform Plan Shows No Changes</h2><p>Before making any updates, confirm your current Terraform configuration matches the infrastructure.</p><p>Run:</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>terraform plan
</span></span></code></pre></div><p>The output should indicate: <code>No changes. Your infrastructure matches the configuration.</code></p><p>This ensures your Terraform template reflects the current state of your infrastructure, avoiding unnecessary changes or errors during migration.</p><h2 id=step-3-backup-your-terraform-state-file>Step 3: Backup Your Terraform State File</h2><p>Before proceeding, back up your Terraform state file. This is critical, as modifications to the state file are part of the process.</p><p>For remote backends (e.g., Azure Blob Storage), ensure you download a copy of the state file.</p><h2 id=step-4-remove-the-existing-container-from-terraform-state>Step 4: Remove the Existing Container from Terraform State</h2><p>Remove the storage container resource from the Terraform state to dissociate it temporarily from management.</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>terraform state rm azurerm_storage_container.sc
</span></span></code></pre></div><p>Replace <code>sc</code> with the name of your storage container resource in the Terraform configuration.</p><blockquote><p><strong>Note</strong>: This action removes the container only from the state file, not from Azure.</p></blockquote><h2 id=step-5-update-the-terraform-configuration>Step 5: Update the Terraform Configuration</h2><p>Modify the azurerm_storage_container resource in your Terraform template by replacing storage_account_name with storage_account_id.</p><p>Before:</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8839ef>resource</span> <span style=color:#40a02b>&#34;azurerm_storage_container&#34; &#34;sc&#34;</span> {
</span></span><span style=display:flex><span>  name                  <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#40a02b>&#34;mycontainer&#34;</span>
</span></span><span style=display:flex><span>  storage_account_name  <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>azurerm_storage_account</span>.<span style=color:#8839ef>sa</span>.<span style=color:#8839ef>name</span>
</span></span><span style=display:flex><span>  container_access_type <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#40a02b>&#34;private&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>After:</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8839ef>resource</span> <span style=color:#40a02b>&#34;azurerm_storage_container&#34; &#34;sc&#34;</span> {
</span></span><span style=display:flex><span>  name                  <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#40a02b>&#34;mycontainer&#34;</span>
</span></span><span style=display:flex><span>  storage_account_id    <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>azurerm_storage_account</span>.<span style=color:#8839ef>sa</span>.<span style=color:#8839ef>id</span>
</span></span><span style=display:flex><span>  container_access_type <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#40a02b>&#34;private&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=step-6-import-the-existing-storage-container>Step 6: Import the Existing Storage Container</h3><p>Re-associate the existing storage container with Terraform using the import command. You’ll need the storage container’s resource ID.</p><p>Find the resource ID:</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>az storage account show <span style=color:#1e66f5>\
</span></span></span><span style=display:flex><span><span style=color:#1e66f5></span>  --name &lt;storage-account-name&gt; <span style=color:#1e66f5>\
</span></span></span><span style=display:flex><span><span style=color:#1e66f5></span>  --resource-group &lt;resource-group-name&gt; <span style=color:#1e66f5>\
</span></span></span><span style=display:flex><span><span style=color:#1e66f5></span>  --query id <span style=color:#1e66f5>\
</span></span></span><span style=display:flex><span><span style=color:#1e66f5></span>  --output tsv
</span></span></code></pre></div><p>Run the import:</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>terraform import azurerm_storage_container.sc <span style=color:#1e66f5>\
</span></span></span><span style=display:flex><span><span style=color:#1e66f5></span>  <span style=color:#40a02b>&#34;/subscriptions/&lt;subscription-id&gt;/resourceGroups/&lt;resource-group-name&gt;/providers/Microsoft.Storage/storageAccounts/&lt;storage-account-name&gt;/blobServices/default/containers/&lt;container-name&gt;&#34;</span>
</span></span></code></pre></div><p>Replace placeholders (<strong>&#171;subscription-id&#187;</strong>, <strong>&#171;resource-group-name&#187;</strong>, etc.) with actual values.</p><h2 id=step-7-verify-terraform-plan>Step 7: Verify Terraform Plan</h2><p>Finally, ensure Terraform recognizes the updated configuration and state without attempting changes.</p><p>Run:</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>terraform plan
</span></span></code></pre></div><p>The output should again confirm: <code>No changes. Your infrastructure matches the configuration.</code></p><h2 id=conclusion>Conclusion</h2><p>This step-by-step process ensures a smooth transition to the new storage_account_id argument without risking data loss in your storage container. Always back up your Terraform state file before making any significant changes and validate each step to prevent issues.</p><p>If you’ve encountered similar challenges or have tips to share, feel free to leave a comment below!</p><p>Feel free to adapt this further for tone or audience!</p></div><h2>Comments</h2><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//byalexblog.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></main></body></html>