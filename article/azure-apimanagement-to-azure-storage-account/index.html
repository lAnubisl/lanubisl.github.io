<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.134.2"><meta name=viewport content="width=device-width,initial-scale=1"><title>Azure API Management to Azure Storage Account &#183; by Alex Code blog</title>
<meta name=keywords content="azure,apim,storageaccount,blobstorage,terraform"><meta name=description content="How to configure Azure API Management to upload a file to Azure Storage Account"><link type=text/css rel=stylesheet href=https://byalexblog.net/css/print.css media=print><link type=text/css rel=stylesheet href=https://byalexblog.net/css/poole.css><link type=text/css rel=stylesheet href=https://byalexblog.net/css/syntax.css><link type=text/css rel=stylesheet href=https://byalexblog.net/css/hyde.css><link type=text/css rel=stylesheet href=https://byalexblog.net/css/vs_theme_style.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png></head><body><aside class=sidebar><div class=container><div class=sidebar-about><a href=https://byalexblog.net/><h1>by Alex Code blog</h1></a><p class=lead>Smart thoughts... and not very smart too!</p></div><nav><ul class=sidebar-nav><li><a href=https://byalexblog.net/>Home</a></li><li><a href=https://byalexblog.net/article>Articles</a></li><li><a href=https://github.com/lanubisl target=_blank>Github</a></li><li><a href=https://www.linkedin.com/in/panfilenok target=_blank>LinkedIn</a></li></ul></nav><p>&copy; 2024. All rights reserved.</p></div></aside><main class="content container"><div class=post><h1>Azure API Management to Azure Storage Account</h1><time datetime=2023-07-06T08:32:23Z class=post-date>Thu, Jul 6, 2023</time><p><img src=/images/azure-apimanagement-to-azure-storage-account/apim_to_blob.jpg alt></p><p>There can be the case when you need to upload a file or metadata to <a href=https://learn.microsoft.com/en-us/azure/storage/common/storage-account-overview target=_blank rel=noopener>Azure Storage Account</a> from an application which is outside of your cloud infrastructure. You should not expose your storage account to the internet for that purpose. There are many reasons for that: securuty, flexibility, monitoring etc. The natural solution to acheave the goal is to use something in between of your Azure Storage Account and the public internet. Some kind of HTTP proxy that will manage user authentication, do some simple validations and then pass the request to Storage Account to save the request body data as a blob. <a href=https://azure.microsoft.com/en-us/products/api-management target=_blank rel=noopener>Azure API Management</a> is a perfect candidate for that role. It is a fully managed service that means you don&rsquo;t need to create any custom application. It is highly available and scalable. It has a lot of features that can be used for your needs.</p><p>In this article I will show how to configure Azure API Management to upload a file to Azure Storage Account.</p><p>I will use <a href=https://www.terraform.io/ target=_blank rel=noopener>Terraform</a> to describe the infrastructure.
To make it more interesting I will create two brands: Adidas and Nike. Each brand will have its own storage account. The goal is to upload a file to the corresponding storage account container depending on the brand. The API consumer will pass the brand name in the request header.</p><h2 id=infrastructure>Infrastructure</h2><p>First, I will create two storage accounts and two containers in each of them. One storage account will be used for Adidas brand and another one for Nike brand. Each brand will have its own container.
Then I will create Azure API Management instance.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#75715e># Resource group for all resources
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_resource_group&#34; &#34;rg&#34;</span> {
</span></span><span style=display:flex><span>  name     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;rg-apim-to-blob&#34;</span>
</span></span><span style=display:flex><span>  location <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;westeurope&#34;</span>
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># Storage account for Adidas brand
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_storage_account&#34; &#34;sa_adidas&#34;</span> {
</span></span><span style=display:flex><span>  name                            <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;stadidas6july2023&#34;</span>
</span></span><span style=display:flex><span>  resource_group_name             <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>rg</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>  location                        <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>rg</span>.<span style=color:#66d9ef>location</span>
</span></span><span style=display:flex><span>  account_tier                    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Standard&#34;</span>
</span></span><span style=display:flex><span>  account_replication_type        <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;LRS&#34;</span>
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># Container for Adidas brand
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_storage_container&#34; &#34;sc_adidas&#34;</span> {
</span></span><span style=display:flex><span>  name                  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;reports&#34;</span>
</span></span><span style=display:flex><span>  storage_account_name  <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_storage_account</span>.<span style=color:#66d9ef>sa_adidas</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>  container_access_type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;private&#34;</span>
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># Storage account for Nike brand
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_storage_account&#34; &#34;sa_nike&#34;</span> {
</span></span><span style=display:flex><span>  name                            <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;stnike6july2023&#34;</span>
</span></span><span style=display:flex><span>  resource_group_name             <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>rg</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>  location                        <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>rg</span>.<span style=color:#66d9ef>location</span>
</span></span><span style=display:flex><span>  account_tier                    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Standard&#34;</span>
</span></span><span style=display:flex><span>  account_replication_type        <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;LRS&#34;</span>
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># Container for Nike brand
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_storage_container&#34; &#34;sc_nike&#34;</span> {
</span></span><span style=display:flex><span>  name                  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;reports&#34;</span>
</span></span><span style=display:flex><span>  storage_account_name  <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_storage_account</span>.<span style=color:#66d9ef>sa_nike</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>  container_access_type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;private&#34;</span>
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># Azure API Management instance
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_api_management&#34; &#34;apim&#34;</span> {
</span></span><span style=display:flex><span>  name                <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;apim-brands-july-2023&#34;</span>
</span></span><span style=display:flex><span>  location            <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>rg</span>.<span style=color:#66d9ef>location</span>
</span></span><span style=display:flex><span>  resource_group_name <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>rg</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>  publisher_name      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;My Company&#34;</span>
</span></span><span style=display:flex><span>  publisher_email     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;john.doe@example.com&#34;</span>
</span></span><span style=display:flex><span>  sku_name            <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Consumption_0&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>identity</span> {
</span></span><span style=display:flex><span>    type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;SystemAssigned&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Next, I will create a role assignment to allow Azure API Management to access the storage account containers.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#75715e># Allow APIM to access the &#39;Adidas&#39; storage account container.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_role_assignment&#34; &#34;sc_adidas_role_assignment&#34;</span> {
</span></span><span style=display:flex><span>  scope                <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_storage_container</span>.<span style=color:#66d9ef>sc_adidas</span>.<span style=color:#66d9ef>resource_manager_id</span>
</span></span><span style=display:flex><span>  role_definition_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Storage Blob Data Contributor&#34;</span>
</span></span><span style=display:flex><span>  principal_id         <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_api_management</span>.<span style=color:#66d9ef>apim</span>.<span style=color:#66d9ef>identity</span>[<span style=color:#ae81ff>0</span>].<span style=color:#66d9ef>principal_id</span>
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># Allow APIM to access the &#39;Nike&#39; storage account container.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_role_assignment&#34; &#34;sc_nike_role_assignment&#34;</span> {
</span></span><span style=display:flex><span>  scope                <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_storage_container</span>.<span style=color:#66d9ef>sc_nike</span>.<span style=color:#66d9ef>resource_manager_id</span>
</span></span><span style=display:flex><span>  role_definition_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Storage Blob Data Contributor&#34;</span>
</span></span><span style=display:flex><span>  principal_id         <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_api_management</span>.<span style=color:#66d9ef>apim</span>.<span style=color:#66d9ef>identity</span>[<span style=color:#ae81ff>0</span>].<span style=color:#66d9ef>principal_id</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Then I will create two backends in Azure API Management. One backend will be used for Adidas brand and another one for Nike brand. Each backend will be configured to use the corresponding storage account container.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#75715e># Backend for Adidas brand
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_api_management_backend&#34; &#34;apim_backend_adidas&#34;</span> {
</span></span><span style=display:flex><span>  name                <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;adidas-storage&#34;</span>
</span></span><span style=display:flex><span>  title               <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;adidas-storage title&#34;</span>
</span></span><span style=display:flex><span>  description         <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Storage account for Adidas Description&#34;</span>
</span></span><span style=display:flex><span>  resource_group_name <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>rg</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>  api_management_name <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_api_management</span>.<span style=color:#66d9ef>apim</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>  protocol            <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http&#34;</span>
</span></span><span style=display:flex><span>  url                 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://${azurerm_storage_account.sa_adidas.name}.blob.core.windows.net/${azurerm_storage_container.sc_adidas.name}&#34;</span>
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># Backend for Nike brand
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_api_management_backend&#34; &#34;apim_backend_nike&#34;</span> {
</span></span><span style=display:flex><span>  name                <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;nike-storage&#34;</span>
</span></span><span style=display:flex><span>  title               <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;nike-storage title&#34;</span>
</span></span><span style=display:flex><span>  description         <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Storage account for Nike Description&#34;</span>
</span></span><span style=display:flex><span>  resource_group_name <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>rg</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>  api_management_name <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_api_management</span>.<span style=color:#66d9ef>apim</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>  protocol            <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http&#34;</span>
</span></span><span style=display:flex><span>  url                 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://${azurerm_storage_account.sa_nike.name}.blob.core.windows.net/${azurerm_storage_container.sc_nike.name}&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Next, I will create a &lsquo;Product&rsquo; in Azure API Management. This product will be used to group APIs and apply policies to them. I will also create one API in Azure API Management. This API will be used to upload a file to Azure Storage Account.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#75715e># Product definition
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_api_management_product&#34; &#34;apim_product&#34;</span> {
</span></span><span style=display:flex><span>  product_id            <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;my_product_id&#34;</span>
</span></span><span style=display:flex><span>  api_management_name   <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_api_management</span>.<span style=color:#66d9ef>apim</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>  resource_group_name   <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>rg</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>  display_name          <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;My Product&#34;</span>
</span></span><span style=display:flex><span>  description           <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;My Product Description&#34;</span>
</span></span><span style=display:flex><span>  terms                 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;My Product Terms&#34;</span>
</span></span><span style=display:flex><span>  subscription_required <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  subscriptions_limit   <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  approval_required     <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  published             <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># API definition
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_api_management_api&#34; &#34;apim_api&#34;</span> {
</span></span><span style=display:flex><span>  name                <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;example-api-name&#34;</span>
</span></span><span style=display:flex><span>  resource_group_name <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>rg</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>  api_management_name <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_api_management</span>.<span style=color:#66d9ef>apim</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>  revision            <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;1&#34;</span>
</span></span><span style=display:flex><span>  display_name        <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Integrations with Azure Managed Services&#34;</span>
</span></span><span style=display:flex><span>  api_type            <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http&#34;</span>
</span></span><span style=display:flex><span>  path                <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;path&#34;</span>
</span></span><span style=display:flex><span>  protocols           <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;https&#34;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>subscription_key_parameter_names</span> {
</span></span><span style=display:flex><span>    header <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;subscription&#34;</span>
</span></span><span style=display:flex><span>    query  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;subscription&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># API to Product association
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_api_management_product_api&#34; &#34;apim_product_api&#34;</span> {
</span></span><span style=display:flex><span>  api_name            <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_api_management_api</span>.<span style=color:#66d9ef>apim_api</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>  product_id          <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_api_management_product</span>.<span style=color:#66d9ef>apim_product</span>.<span style=color:#66d9ef>product_id</span>
</span></span><span style=display:flex><span>  resource_group_name <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>rg</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>  api_management_name <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_api_management</span>.<span style=color:#66d9ef>apim</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># API operation definition
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_api_management_api_operation&#34; &#34;apim_api_opn&#34;</span> {
</span></span><span style=display:flex><span>  operation_id        <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;to-blob-storage&#34;</span>
</span></span><span style=display:flex><span>  api_name            <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_api_management_api</span>.<span style=color:#66d9ef>apim_api</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>  api_management_name <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_api_management_api</span>.<span style=color:#66d9ef>apim_api</span>.<span style=color:#66d9ef>api_management_name</span>
</span></span><span style=display:flex><span>  resource_group_name <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_api_management_api</span>.<span style=color:#66d9ef>apim_api</span>.<span style=color:#66d9ef>resource_group_name</span>
</span></span><span style=display:flex><span>  display_name        <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Send data to the blob storage&#34;</span>
</span></span><span style=display:flex><span>  method              <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;POST&#34;</span>
</span></span><span style=display:flex><span>  url_template        <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/blobstorage&#34;</span>
</span></span><span style=display:flex><span>  description         <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Send data to the blob storage&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And here is the most important part of this example. I will create a <a href=https://learn.microsoft.com/en-us/azure/api-management/api-management-howto-policies target=_blank rel=noopener>policy</a> that will be applied to the API operation. This policy will check the value of the &lsquo;brand&rsquo; header and based on that value it will route the request to the corresponding backend.</p><p>The policy is the combination of inbound, backend, outbound and on-error policies. The inbound policy is executed before the request is forwarded to the backend. The backend policy is executed before the request is forwarded to the backend. The outbound policy is executed after the response is received from the backend. The on-error policy is executed when an error occurs during the request processing.</p><p>Let&rsquo;s take a look at what do we need to do in Inbound policy. First, we need to check the value of the &lsquo;brand&rsquo; header. If the value is &lsquo;adidas&rsquo; then we will route the request to the &lsquo;adidas-storage&rsquo; backend. If the value is &rsquo;nike&rsquo; then we will route the request to the &rsquo;nike-storage&rsquo; backend. If the value is not &lsquo;adidas&rsquo; or &rsquo;nike&rsquo; then we will return the 400 status code with the message &lsquo;Invalid brand&rsquo;.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>&lt;choose&gt;
</span></span><span style=display:flex><span>  &lt;when condition=&#34;@(context.Request.Headers.GetValueOrDefault(&#34;brand&#34;,&#34;&#34;) == &#34;adidas&#34;)&#34;&gt;
</span></span><span style=display:flex><span>    &lt;set-backend-service backend-id=&#34;${azurerm_api_management_backend.apim_backend_adidas.name}&#34; /&gt;
</span></span><span style=display:flex><span>  &lt;/when&gt;
</span></span><span style=display:flex><span>  &lt;when condition=&#34;@(context.Request.Headers.GetValueOrDefault(&#34;brand&#34;,&#34;&#34;) == &#34;nike&#34;)&#34;&gt;
</span></span><span style=display:flex><span>    &lt;set-backend-service backend-id=&#34;${azurerm_api_management_backend.apim_backend_nike.name}&#34; /&gt;
</span></span><span style=display:flex><span>  &lt;/when&gt;
</span></span><span style=display:flex><span>  &lt;otherwise&gt;
</span></span><span style=display:flex><span>    &lt;return-response&gt;
</span></span><span style=display:flex><span>        &lt;set-status code=&#34;400&#34; reason=&#34;Bad Request&#34; /&gt;
</span></span><span style=display:flex><span>        &lt;set-header name=&#34;Content-Type&#34; exists-action=&#34;override&#34;&gt;
</span></span><span style=display:flex><span>        &lt;value&gt;application/json&lt;/value&gt;
</span></span><span style=display:flex><span>        &lt;/set-header&gt;
</span></span><span style=display:flex><span>        &lt;set-body&gt;@{  
</span></span><span style=display:flex><span>        var json = new JObject() {{&#34;Error&#34;, &#34;Invalid brand&#34;}} ;  
</span></span><span style=display:flex><span>        return json.ToString(Newtonsoft.Json.Formatting.None);       
</span></span><span style=display:flex><span>        }&lt;/set-body&gt;
</span></span><span style=display:flex><span>    &lt;/return-response&gt;
</span></span><span style=display:flex><span>  &lt;/otherwise&gt;
</span></span><span style=display:flex><span>&lt;/choose&gt;
</span></span></code></pre></div><p>Here I used the following policies:</p><ul><li><a href=https://learn.microsoft.com/en-us/azure/api-management/choose-policy target=_blank rel=noopener>choose</a> - allows to choose one of the branches based on the condition</li><li><a href=https://learn.microsoft.com/en-us/azure/api-management/set-backend-service-policy target=_blank rel=noopener>set-backend-service</a> - allows to set the backend service that will be used to process the request</li><li><a href=https://learn.microsoft.com/en-us/azure/api-management/return-response-policy target=_blank rel=noopener>return-response</a> - allows to return the response to the client</li></ul><p>Please note that some parts of this policy definition (like <code>@(context.Request.Headers.GetValueOrDefault("brand","") == "adidas")</code>) are <a href=https://learn.microsoft.com/en-us/azure/api-management/api-management-policy-expressions target=_blank rel=noopener>policy expressions</a> but other parts (like <code>${azurerm_api_management_backend.apim_backend_nike.name}</code>) are parts of terraform configuration and evaluated to the corresponding values during terraform execution. The <code>context</code> object is the object that is available in the policy expressions and contains the information about the request and response. You can read more about the <code>context</code> object <a href=https://learn.microsoft.com/en-us/azure/api-management/api-management-policy-expressions#ContextVariables target=_blank rel=noopener>here</a>.</p><p>Now, whe backend is set we can choose the exact path inside the container where the blob should be created.
For this example I will use the following path: <code>/y=yyyy/m=MM/d=dd/h=HH/requestId</code> where the <code>requestId</code> is the unique identifier (GUID) of the request. This will allow us to store the blobs in the following structure:</p><pre tabindex=0><code>/y=2021/m=07/d=01/h=12/5ad1b359-1e24-4c1d-ad1b-35de14e8839c
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>&lt;rewrite-uri 
</span></span><span style=display:flex><span>  template=&#34;@($&#34;{DateTime.UtcNow.ToString(&#34;\\y=yyyy/\\m=MM/\\d=dd/\\h=HH&#34;)}/{context.RequestId.ToString()}&#34;)&#34; copy-unmatched-params=&#34;false&#34; /&gt;
</span></span></code></pre></div><p>Then we need to set the HTTP headers that are required by the <a href="https://learn.microsoft.com/en-us/rest/api/storageservices/put-blob?tabs=azure-ad" target=_blank rel=noopener>Storage Account HTTP API</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>&lt;set-method&gt;PUT&lt;/set-method&gt;
</span></span><span style=display:flex><span>&lt;set-header name=&#34;x-ms-date&#34; exists-action=&#34;override&#34;&gt;
</span></span><span style=display:flex><span>  &lt;value&gt;@(DateTime.UtcNow.ToString(&#34;R&#34;))&lt;/value&gt;
</span></span><span style=display:flex><span>&lt;/set-header&gt;
</span></span><span style=display:flex><span>&lt;set-header name=&#34;x-ms-version&#34; exists-action=&#34;override&#34;&gt;
</span></span><span style=display:flex><span>  &lt;value&gt;2023-01-03&lt;/value&gt;
</span></span><span style=display:flex><span>&lt;/set-header&gt;
</span></span><span style=display:flex><span>&lt;set-header name=&#34;x-ms-blob-type&#34; exists-action=&#34;override&#34;&gt;
</span></span><span style=display:flex><span>  &lt;value&gt;BlockBlob&lt;/value&gt;
</span></span><span style=display:flex><span>&lt;/set-header&gt;
</span></span><span style=display:flex><span>&lt;set-header name=&#34;x-ms-access-tier&#34; exists-action=&#34;override&#34;&gt;
</span></span><span style=display:flex><span>  &lt;value&gt;Hot&lt;/value&gt;
</span></span><span style=display:flex><span>&lt;/set-header&gt;
</span></span></code></pre></div><p>Another important thing is the authentication header. As you could see earlier I used System Assigned Managed Identity to grant access to the Storage Account. In order to authenticate the request we need to use <a href=https://learn.microsoft.com/en-us/azure/api-management/authentication-managed-identity-policy target=_blank rel=noopener>authentication-managed-identity</a> policy. The policy will use the System Assigned Managed Identity to get the access token and then it will add the <code>Authorization</code> header to the request:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>&lt;authentication-managed-identity resource=&#34;https://storage.azure.com/&#34; /&gt;
</span></span></code></pre></div><p>In the outbund policy we will expect the response from the Storage Account HTTP API and we will return the OperationId in the response body:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>&lt;choose&gt;
</span></span><span style=display:flex><span>  &lt;when condition=&#34;@(context.Response.StatusCode == 201)&#34;&gt;
</span></span><span style=display:flex><span>    &lt;set-header name=&#34;Content-Type&#34; exists-action=&#34;override&#34;&gt;
</span></span><span style=display:flex><span>      &lt;value&gt;application/json&lt;/value&gt;
</span></span><span style=display:flex><span>    &lt;/set-header&gt;
</span></span><span style=display:flex><span>    &lt;set-body&gt;@{  
</span></span><span style=display:flex><span>      var json = new JObject() {{&#34;OperationId&#34;, context.RequestId}};  
</span></span><span style=display:flex><span>      return json.ToString(Newtonsoft.Json.Formatting.None);       
</span></span><span style=display:flex><span>    }&lt;/set-body&gt;
</span></span><span style=display:flex><span>  &lt;/when&gt;
</span></span><span style=display:flex><span>&lt;/choose&gt;
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_api_management_api_operation_policy&#34; &#34;apim_api_operation_policy_blobstorage&#34;</span> {
</span></span><span style=display:flex><span>  api_name            <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_api_management_api_operation</span>.<span style=color:#66d9ef>apim_api_opn</span>.<span style=color:#66d9ef>api_name</span>
</span></span><span style=display:flex><span>  api_management_name <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_api_management_api_operation</span>.<span style=color:#66d9ef>apim_api_opn</span>.<span style=color:#66d9ef>api_management_name</span>
</span></span><span style=display:flex><span>  resource_group_name <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_api_management_api_operation</span>.<span style=color:#66d9ef>apim_api_opn</span>.<span style=color:#66d9ef>resource_group_name</span>
</span></span><span style=display:flex><span>  operation_id        <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_api_management_api_operation</span>.<span style=color:#66d9ef>apim_api_opn</span>.<span style=color:#66d9ef>operation_id</span>
</span></span><span style=display:flex><span>  xml_content         <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>&lt;&lt;</span><span style=color:#66d9ef>XML</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>policies</span><span style=color:#960050;background-color:#1e0010>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>inbound</span><span style=color:#960050;background-color:#1e0010>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>base</span> <span style=color:#960050;background-color:#1e0010>/&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>    # Our custom inbound policy
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#960050;background-color:#1e0010>&lt;/</span><span style=color:#66d9ef>inbound</span><span style=color:#960050;background-color:#1e0010>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>backend</span><span style=color:#960050;background-color:#1e0010>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>base</span> <span style=color:#960050;background-color:#1e0010>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>&lt;/</span><span style=color:#66d9ef>backend</span><span style=color:#960050;background-color:#1e0010>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>outbound</span><span style=color:#960050;background-color:#1e0010>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>base</span> <span style=color:#960050;background-color:#1e0010>/&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>    # Our custom outbound policy
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#960050;background-color:#1e0010>&lt;/</span><span style=color:#66d9ef>outbound</span><span style=color:#960050;background-color:#1e0010>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>on</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#66d9ef>error</span><span style=color:#960050;background-color:#1e0010>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>base</span> <span style=color:#960050;background-color:#1e0010>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>&lt;/</span><span style=color:#66d9ef>on</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#66d9ef>error</span><span style=color:#960050;background-color:#1e0010>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>&lt;/</span><span style=color:#66d9ef>policies</span><span style=color:#960050;background-color:#1e0010>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>XML</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>That&rsquo;s it! you can find the full example <a href=https://gist.github.com/lAnubisl/4dcea7b448ce032c572116176bb4a0a3 target=_blank rel=noopener>here</a>.</p><h2 id=testing>Testing</h2><p>To test our API we first need to create new subscription key and get it&rsquo;s value.
<img src=/images/azure-apimanagement-to-azure-storage-account/apim_to_blob_subscription_key.png alt>
Then we can use a tool like <a href=https://www.postman.com/ target=_blank rel=noopener>Postman</a> to send a request to our API:
<img src=/images/azure-apimanagement-to-azure-storage-account/apim_to_blob_postman.png alt>
And finally we can check the blob in the Azure Storage Account:
<img src=/images/azure-apimanagement-to-azure-storage-account/apim_to_blob_result.png alt></p><h2 id=conclusion>Conclusion</h2><p>In this article we learned how to use Azure API Management to create an API that will store the request body in the Azure Storage Account. We also learned how to use Terraform to automate the deployment of the solution. I hope you enjoyed this article and found it useful. If you have any questions please leave a comment below.</p></div><h2>Comments</h2><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//byalexblog.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></main></body></html>