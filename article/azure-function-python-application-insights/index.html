<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.135.0"><meta name=viewport content="width=device-width,initial-scale=1"><title>Azure Function (Python) Application Insights &#183; by Alex Code blog</title>
<meta name=keywords content="azure,azure function,python,logging,opentelimetry,application insights"><meta name=description content="How to configure Application Insights logging for Python Azure Function"><link type=text/css rel=stylesheet href=https://byalexblog.net/css/print.css media=print><link type=text/css rel=stylesheet href=https://byalexblog.net/css/poole.css><link type=text/css rel=stylesheet href=https://byalexblog.net/css/syntax.css><link type=text/css rel=stylesheet href=https://byalexblog.net/css/hyde.css><link type=text/css rel=stylesheet href=https://byalexblog.net/css/vs_theme_style.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png></head><body><aside class=sidebar><div class=container><div class=sidebar-about><a href=https://byalexblog.net/><h1>by Alex Code blog</h1></a><p class=lead>Smart thoughts... and not very smart too!</p></div><nav><ul class=sidebar-nav><li><a href=https://byalexblog.net/>Home</a></li><li><a href=https://byalexblog.net/article>Articles</a></li><li><a href=https://github.com/lanubisl target=_blank>Github</a></li><li><a href=https://www.linkedin.com/in/panfilenok target=_blank>LinkedIn</a></li></ul></nav><p>&copy; 2024. All rights reserved.</p></div></aside><main class="content container"><div class=post><h1>Azure Function (Python) Application Insights</h1><time datetime=2024-10-05T11:32:19Z class=post-date>Sat, Oct 5, 2024</time><p>I have some Python Azure Functions and recently I decided to review and improve the logging mechanism for them (Azure Application Insights integration). What I wanted to acheave is to have visual spans for individual
function calls that can be nested and give the better idea of the function call behavior.</p><p><img src=/images/azure-function-python-application-insights/application-insights-spans.png alt></p><h3 id=long-story-short-solution>Long story short (Solution):</h3><p>Use <a href=https://pypi.org/project/azure-monitor-opentelemetry/ target=_blank rel=noopener>azure-monitor-opentelemetry</a> python package:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> logging
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> requests
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> azure.functions <span style=color:#66d9ef>as</span> func
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> opentelemetry.trace
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> azure.monitor.opentelemetry <span style=color:#f92672>import</span> configure_azure_monitor
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>configure_azure_monitor()
</span></span><span style=display:flex><span>tracer: opentelemetry<span style=color:#f92672>.</span>trace<span style=color:#f92672>.</span>Tracer <span style=color:#f92672>=</span> opentelemetry<span style=color:#f92672>.</span>trace<span style=color:#f92672>.</span>get_tracer(__name__)
</span></span><span style=display:flex><span>app <span style=color:#f92672>=</span> func<span style=color:#f92672>.</span>FunctionApp(http_auth_level<span style=color:#f92672>=</span>func<span style=color:#f92672>.</span>AuthLevel<span style=color:#f92672>.</span>ANONYMOUS)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app.timer_trigger</span>(schedule<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0 * * * * *&#34;</span>, arg_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;timer&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>timer_trigger</span>(timer: func<span style=color:#f92672>.</span>TimerRequest) <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>    logging<span style=color:#f92672>.</span>info(<span style=color:#e6db74>&#34;Call: TimerTrigger Started&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> RunBusinessLogic()
</span></span><span style=display:flex><span>    logging<span style=color:#f92672>.</span>info(<span style=color:#e6db74>&#34;Call: TimerTrigger Ended&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app.function_name</span>(name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;GetRecord&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app.route</span>(route<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;GetRecord&#34;</span>, methods<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#34;GET&#34;</span>])
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>GetRecord</span>(req: func<span style=color:#f92672>.</span>HttpRequest) <span style=color:#f92672>-&gt;</span> func<span style=color:#f92672>.</span>HttpResponse:
</span></span><span style=display:flex><span>    logging<span style=color:#f92672>.</span>info(<span style=color:#e6db74>&#34;Call: GetRecord Started&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> RunBusinessLogic()
</span></span><span style=display:flex><span>    logging<span style=color:#f92672>.</span>info(<span style=color:#e6db74>&#34;Call: GetRecord Ended&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> func<span style=color:#f92672>.</span>HttpResponse(<span style=color:#e6db74>&#34;Done&#34;</span>, status_code<span style=color:#f92672>=</span><span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>RunBusinessLogic</span>() <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> tracer<span style=color:#f92672>.</span>start_as_current_span(<span style=color:#e6db74>&#34;My Business Logic&#34;</span>):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> tracer<span style=color:#f92672>.</span>start_as_current_span(<span style=color:#e6db74>&#34;HTTP Request to Google&#34;</span>):
</span></span><span style=display:flex><span>            google_resp <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get(url<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;https://google.com&#39;</span>)
</span></span><span style=display:flex><span>            logging<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;google response status code </span><span style=color:#e6db74>{</span>google_resp<span style=color:#f92672>.</span>status_code<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> tracer<span style=color:#f92672>.</span>start_as_current_span(<span style=color:#e6db74>&#34;HTTP Request to Microsoft&#34;</span>):
</span></span><span style=display:flex><span>            msft_resp <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get(url<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;https://www.microsoft.com&#39;</span>)
</span></span><span style=display:flex><span>            logging<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;msft response status code </span><span style=color:#e6db74>{</span>msft_resp<span style=color:#f92672>.</span>status_code<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span></code></pre></div><p>And make sure you set <code>OTEL_LOGS_EXPORTER</code> Environment Variable (App Setting) to <code>None</code> as it is described here: <a href=https://learn.microsoft.com/en-us/troubleshoot/azure/azure-monitor/app-insights/telemetry/opentelemetry-troubleshooting-python#duplicate-trace-logs-in-azure-functions target=_blank rel=noopener>Duplicate trace logs in Azure Functions</a>. If you do not do this your trace logs will be duplicated.</p><p>Here is how it should be:
<img src=/images/azure-function-python-application-insights/application-insights-plain.png alt></p><p>That&rsquo;s it.</p><h3 id=longer-story-also-short-with-links>Longer story (also short) with links:</h3><p>There is no <a href=https://learn.microsoft.com/en-us/azure/azure-monitor/app/asp-net-dependencies#dependency-auto-collection target=_blank rel=noopener>automatic dependency and transaction diagnostic auto collection</a>. There are also no samples of <a href=https://learn.microsoft.com/en-us/azure/azure-monitor/app/api-custom-events-metrics#trackdependency target=_blank rel=noopener>how to track dependencies manually</a> for python Azure Functions. <a href="https://learn.microsoft.com/en-us/azure/azure-functions/functions-reference-python?tabs=get-started%2Casgi%2Capplication-level&amp;pivots=python-mode-decorators#log-custom-telemetry" target=_blank rel=noopener>The Azure Functions Python Developer Reference Guide</a> describes how to Log Custom Telimetry using OpenCensus library. You can
also find samples of how to use this library <a href=https://learn.microsoft.com/en-us/azure/architecture/guide/devops/monitor-with-opencensus-application-insights target=_blank rel=noopener>Monitor a distributed system by using Application Insights and OpenCensus</a>. However&mldr; you should not use it because <a href="https://azure.microsoft.com/en-us/updates/python-opencensus-retirement/#:~:text=On%2030%20September%202024%2C%20we,a%20single%20line%2Dof%2Dcode" target=_blank rel=noopener>Azure Monitor support for OpenCensus will end on 30 September 2024 - transition to using Azure Monitor OpenTelemetry Python Distro</a>. Here is the guide for <a href=https://learn.microsoft.com/en-us/azure/azure-monitor/app/opentelemetry-python-opencensus-migrate target=_blank rel=noopener>Migrating from OpenCensus Python SDK and Azure Monitor OpenCensus exporter for Python to Azure Monitor OpenTelemetry Python Distro</a>.</p></div><h2>Comments</h2><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//byalexblog.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></main></body></html>