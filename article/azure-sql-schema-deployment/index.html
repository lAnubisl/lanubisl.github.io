<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.117.0"><meta name=viewport content="width=device-width,initial-scale=1"><title>Breaking Through Barriers: Simplifying CD with Automated Azure SQL Schema Changes! &#183; by Alex Code blog</title><meta name=keywords content="azure,sql,database schema,deployment,dacfx,sqlpackage,azuredevops,gitlab,github"><meta name=description content="How to deploy a Microsoft SQL database schema to Azure SQL using any linux-based CI/CD pipeline (Gitlab, GitHub, Azure DevOps, etc)."><link type=text/css rel=stylesheet href=https://byalexblog.net/css/print.css media=print><link type=text/css rel=stylesheet href=https://byalexblog.net/css/poole.css><link type=text/css rel=stylesheet href=https://byalexblog.net/css/syntax.css><link type=text/css rel=stylesheet href=https://byalexblog.net/css/hyde.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png></head><body><aside class=sidebar><div class=container><div class=sidebar-about><a href=https://byalexblog.net/><h1>by Alex Code blog</h1></a><p class=lead>Smart thoughts... and not very smart too!</p></div><nav><ul class=sidebar-nav><li><a href=https://byalexblog.net/>Home</a></li><li><a href=https://byalexblog.net/article>Articles</a></li><li><a href=https://github.com/lanubisl target=_blank>Github</a></li><li><a href=https://www.linkedin.com/in/panfilenok target=_blank>LinkedIn</a></li></ul></nav><p>&copy; 2023. All rights reserved.</p></div></aside><main class="content container"><div class=post><h1>Breaking Through Barriers: Simplifying CD with Automated Azure SQL Schema Changes!</h1><time datetime=2023-06-10T10:57:21Z class=post-date>Sat, Jun 10, 2023</time><p><img src=/images/azure-sql-schema-deployment/logo.jpg alt></p><p>Have you ever tried to deploy a Microsoft SQL database schema to Azure SQL using a linux-based CI/CD pipeline? If you did, you probably know that it is not a trivial task. The reason is that the <a href=https://www.nuget.org/packages/Microsoft.Data.Tools.Msbuild target=_blank rel=noopener>Microsoft.Data.Tools.Msbuild</a> package is not available for linux. The package contains MSBuild targets and properties that are used to build and deploy database projects. The package is a part of <a href="https://docs.microsoft.com/en-us/sql/ssdt/download-sql-server-data-tools-ssdt?view=sql-server-ver15" target=_blank rel=noopener>SQL Server Data Tools (SSDT)</a> and it is not available for linux. So if you want to deploy a database schema to Azure SQL using a linux-based CI/CD pipeline you need to use a different approach.</p><p>In this article we will see how to deploy a Microsoft SQL database schema to Azure SQL using <strong>any</strong> linux-based CI/CD pipeline (Gitlab, GitHub, Azure DevOps, etc).</p><blockquote><p>DISCLAIMER: At the moment of writing the <a href=https://www.nuget.org/packages/Microsoft.Build.Sql target=_blank rel=noopener>Microsoft.Build.Sql</a> is in preview and the documentation is not complete. So use the information in this article at your own risk.</p></blockquote><h1 id=prerequisites>Prerequisites</h1><p>You need to have the following tools installed:</p><ul><li><a href=https://dotnet.microsoft.com/download target=_blank rel=noopener>dotnet sdk</a> (At the monemt of writing the DacFx tool requires dotnet 6.0, not the latest version)</li><li><a href=https://github.com/microsoft/DacFx target=_blank rel=noopener>sqlpackage (DacFx)</a></li><li><a href=https://docs.microsoft.com/en-us/cli/azure/install-azure-cli target=_blank rel=noopener>az cli</a></li></ul><h1 id=database-schema-definition>Database schema definition</h1><p>We are going to use <a href="https://learn.microsoft.com/en-us/previous-versions/sql/sql-server-data-tools/hh272702%28v=vs.103%29?redirectedfrom=MSDN" target=_blank rel=noopener>Database Project</a> to define any aspect of our database schema. The project is a set of SQL scripts that are executed in a specific order to create a database schema. The project can be created in <a href=https://visualstudio.microsoft.com/ target=_blank rel=noopener>Visual Studio</a>, using <a href="https://docs.microsoft.com/en-us/sql/ssdt/download-sql-server-data-tools-ssdt?view=sql-server-ver15" target=_blank rel=noopener>SQL Server Data Tools</a> or in <a href=https://code.visualstudio.com target=_blank rel=noopener>Visual Studio Code</a> using <a href=https://github.com/microsoft/DacFx target=_blank rel=noopener>DacFx</a>.</p><p>In this article we will use Visual Studio Code and DacFx. The reason is that we want to use a linux-based CI/CD pipeline and Visual Studio is not available on linux. Visual Studio Code is available on linux and DacFx is a cross-platform tool.</p><h2 id=create-a-database-project>Create a database project</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># install the project template</span>
</span></span><span style=display:flex><span>dotnet new -i Microsoft.Build.Sql.Templates
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># create a new database project</span>
</span></span><span style=display:flex><span>dotnet new sqlproj -n ProductsTutorial
</span></span></code></pre></div><p>As a result there will be a new directory <strong>ProductsTutorial</strong> with the following files:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ProductsTutorial
</span></span><span style=display:flex><span>└── ProductsTutorial.sqlproj
</span></span></code></pre></div><p>The <strong>ProductsTutorial.sqlproj</strong> is a project file that describes the database project. It is a regular MSBuild project file with some additional properties and targets.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;Project</span> <span style=color:#a6e22e>DefaultTargets=</span><span style=color:#e6db74>&#34;Build&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;Sdk</span> <span style=color:#a6e22e>Name=</span><span style=color:#e6db74>&#34;Microsoft.Build.Sql&#34;</span> <span style=color:#a6e22e>Version=</span><span style=color:#e6db74>&#34;0.1.10-preview&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;PropertyGroup&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;Name&gt;</span>ProductsTutorial2<span style=color:#f92672>&lt;/Name&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;DSP&gt;</span>Microsoft.Data.Tools.Schema.Sql.Sql160DatabaseSchemaProvider<span style=color:#f92672>&lt;/DSP&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;ModelCollation&gt;</span>1033, CI<span style=color:#f92672>&lt;/ModelCollation&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/PropertyGroup&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/Project&gt;</span>
</span></span></code></pre></div><p>The <strong>Microsoft.Build.Sql</strong> SDK is a set of MSBuild targets and properties that are used to build and deploy database projects. The <strong>DSP</strong> property defines the version of the SQL Server Data Tools (SSDT) schema provider. The <strong>ModelCollation</strong> property defines the default collation for the database.</p><p>Add a new file <strong>dbo.Product.sql</strong> alongside the project file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> dbo.Product (
</span></span><span style=display:flex><span>    Id INT <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>IDENTITY</span>(<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span>,
</span></span><span style=display:flex><span>    Name NVARCHAR(<span style=color:#ae81ff>100</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>    Price DECIMAL(<span style=color:#ae81ff>18</span>,<span style=color:#ae81ff>2</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><h2 id=configure-the-project-for-azure-sql>Configure the project for Azure SQL</h2><p>Before we build the project we need to make sure that the target database version is set correctly. The default version is SQL Server 2019. We are going to use Azure SQL, so we need to change the target version in sqlproj file (Set DSP to &lsquo;<strong>Microsoft.Data.Tools.Schema.Sql.SqlAzureV12DatabaseSchemaProvider</strong>&rsquo;).
<img src=/images/azure-sql-schema-deployment/Microsoft.Data.Tools.Schema.Sql.SqlAzureV12DatabaseSchemaProvider.png alt></p><h1 id=build-and-deploy-the-project>Build and deploy the project</h1><p>I will use simple bash script to build and deploy the project. The script is self-explanatory. The only thing that is worth mentioning is that we need to obtain an access token for Azure SQL. The token is used to authenticate the deployment. The token is obtained using <a href=https://docs.microsoft.com/en-us/cli/azure/install-azure-cli target=_blank rel=noopener>az cli</a> and then passed to sqlpackage tool.</p><p>I will use an example of the <a href=https://docs.microsoft.com/en-us/azure/active-directory/develop/app-objects-and-service-principals target=_blank rel=noopener>Azure Service Principal authentication</a> (As the most commonly used for CI/CD piplines AFAIK). But it is also possible to use <a href=https://learn.microsoft.com/en-us/azure/active-directory/hybrid/connect/whatis-fed target=_blank rel=noopener>Azure Federation Authentication</a>, for local use you can just do <code>az login</code>. Or you can use <a href="https://learn.microsoft.com/en-us/sql/relational-databases/security/choose-an-authentication-mode?view=sql-server-ver16#connecting-through-sql-server-authentication" target=_blank rel=noopener>Sql Server Authentication</a>, but I do not recommend that.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># build step </span>
</span></span><span style=display:flex><span>dotnet build ProductsTutorial/ProductsTutorial.sqlproj
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># deploy step</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 1. sign in to azure using azure cli.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># $ARM_CLIENT_ID is the application id of the service principal</span>
</span></span><span style=display:flex><span><span style=color:#75715e># $ARM_CLIENT_SECRET is the secret of the service principal</span>
</span></span><span style=display:flex><span><span style=color:#75715e># $ARM_TENANT_ID is the tenatn id of the azure subscription</span>
</span></span><span style=display:flex><span>az login --service-principal -u $ARM_CLIENT_ID -p $ARM_CLIENT_SECRET --tenant $ARM_TENANT_ID
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2. deploy the database project to azure sql</span>
</span></span><span style=display:flex><span><span style=color:#75715e># obtain the access token for azure sql</span>
</span></span><span style=display:flex><span>token<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>az account get-access-token --resource<span style=color:#f92672>=</span>https://database.windows.net/ --query accessToken --output tsv<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># deploy the database project to azure sql</span>
</span></span><span style=display:flex><span>sqlpackage <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    /Action:Publish <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    /SourceFile:<span style=color:#e6db74>&#34;ProductsTutorial/bin/Debug/ProductsTutorial.dacpac&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    /AccessToken:$token <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    /TargetConnectionString:<span style=color:#e6db74>&#34;Server=[YOUR_SERVER_NAME].database.windows.net; Encrypt=True; Database=[YOUR_DATABASE_NAME];&#34;</span>
</span></span></code></pre></div><p>The output should look like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Publishing to database <span style=color:#e6db74>&#39;sqldb-database-project-deployment&#39;</span> on server <span style=color:#e6db74>&#39;sql-database-project-deployment.database.windows.net&#39;</span>.
</span></span><span style=display:flex><span>Initializing deployment <span style=color:#f92672>(</span>Start<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Initializing deployment <span style=color:#f92672>(</span>Complete<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Analyzing deployment plan <span style=color:#f92672>(</span>Start<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Analyzing deployment plan <span style=color:#f92672>(</span>Complete<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Updating database <span style=color:#f92672>(</span>Start<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;QUERY_STORE=OFF&#39;</span> is not supported in this version of SQL Server.
</span></span><span style=display:flex><span>Creating SqlTable <span style=color:#f92672>[</span>dbo<span style=color:#f92672>]</span>.<span style=color:#f92672>[</span>Product<span style=color:#f92672>]</span>...
</span></span><span style=display:flex><span>Update complete.
</span></span><span style=display:flex><span>Updating database <span style=color:#f92672>(</span>Complete<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Successfully published database.
</span></span><span style=display:flex><span>Changes to connection setting default values were incorporated in a recent release.  More information is available at https://aka.ms/dacfx-connection
</span></span><span style=display:flex><span>Time elapsed 0:01:58.04
</span></span></code></pre></div><p>After the deployment is complete, you can check the database in the <a href=https://portal.azure.com/ target=_blank rel=noopener>Azure Portal</a>. The database should contain the <strong>dbo.Product</strong> table.</p><p>You can find the repository with the source code for this article <a href=https://github.com/lAnubisl/DatabaseProjectLinux target=_blank rel=noopener>here</a>.</p><h1 id=additional-resources>Additional resources</h1><ul><li>Repository: <a href=https://github.com/lAnubisl/DatabaseProjectLinux target=_blank rel=noopener>Tutorial</a></li><li>Repository: <a href=https://github.com/azure/sql-action target=_blank rel=noopener>GitHub Action</a></li><li>Article: <a href=https://techcommunity.microsoft.com/t5/azure-sql-blog/microsoft-build-sql-the-next-frontier-of-sql-projects/ba-p/3290628 target=_blank rel=noopener>Microsoft.Build.Sql: the next frontier of SQL projects</a></li><li>NuGet package: <a href=https://www.nuget.org/packages/Microsoft.Build.Sql/ target=_blank rel=noopener>Microsoft.Build.Sql</a></li><li>VsCode extension: <a href="https://marketplace.visualstudio.com/items?itemName=ms-mssql.sql-database-projects-vscode" target=_blank rel=noopener>SQL Database Projects</a></li></ul></div><h2>Comments</h2><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//byalexblog.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></main><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-44968940-4","auto"),ga("send","pageview"))</script></body></html>