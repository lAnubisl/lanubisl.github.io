<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.120.4"><meta name=viewport content="width=device-width,initial-scale=1"><title>Azure Function Serverless Deployment Python &#183; by Alex Code blog</title>
<meta name=keywords content="azure,serverless,azure function,python,deployment,devops,terraform"><meta name=description content="How to deploy Python Azure Function App to Linux Consumption Azure Function resource using Zip Deployment."><link type=text/css rel=stylesheet href=https://byalexblog.net/css/print.css media=print><link type=text/css rel=stylesheet href=https://byalexblog.net/css/poole.css><link type=text/css rel=stylesheet href=https://byalexblog.net/css/syntax.css><link type=text/css rel=stylesheet href=https://byalexblog.net/css/hyde.css><link type=text/css rel=stylesheet href=https://byalexblog.net/css/vs_theme_style.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png></head><body><aside class=sidebar><div class=container><div class=sidebar-about><a href=https://byalexblog.net/><h1>by Alex Code blog</h1></a><p class=lead>Smart thoughts... and not very smart too!</p></div><nav><ul class=sidebar-nav><li><a href=https://byalexblog.net/>Home</a></li><li><a href=https://byalexblog.net/article>Articles</a></li><li><a href=https://github.com/lanubisl target=_blank>Github</a></li><li><a href=https://www.linkedin.com/in/panfilenok target=_blank>LinkedIn</a></li></ul></nav><p>&copy; 2023. All rights reserved.</p></div></aside><main class="content container"><div class=post><h1>Azure Function Serverless Deployment Python</h1><time datetime=2023-05-26T12:03:58Z class=post-date>Fri, May 26, 2023</time><p><img src=/images/azure-function-serverless-deployment-python/logo.jpg alt></p><p>Consumption plan is the cheapest way to run your Azure Function. However, it has some limitations. For example, you can not use Web Deploy, Docker Container, Source Control, FTP, Cloud sync or Local Git. You can use <a href=https://learn.microsoft.com/en-us/azure/azure-functions/functions-deployment-technologies#external-package-url target=_blank rel=noopener>External package URL</a> or <a href=https://learn.microsoft.com/en-us/azure/azure-functions/functions-deployment-technologies#zip-deploy target=_blank rel=noopener>Zip deploy</a> instead. In this article I will show you how to deploy Python Azure Function <a href=https://techcommunity.microsoft.com/t5/azure-compute-blog/azure-functions-v2-python-programming-model/ba-p/3665168 target=_blank rel=noopener>Programming Model v2</a> App to Linux Consumption Azure Function resource using Zip Deployment.</p><h2 id=create-azure-function-resource>Create azure function resource</h2><p>I will use <a href=https://www.terraform.io target=_blank rel=noopener>terraform</a> to create the azure function resource. The terraform code is shown below. The code is also available on <a href=https://github.com/lAnubisl/AzureFunctionPythonLinuxConsumptionZipDeployment/blob/main/terraform_infrastructure/main.tf target=_blank rel=noopener>github</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#75715e># Here we define the resource group where the function will be deployed. https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/resource_group
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_resource_group&#34;</span> <span style=color:#e6db74>&#34;rg&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span>     = <span style=color:#e6db74>&#34;rg-func-python-deployment-test&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>location</span> = <span style=color:#e6db74>&#34;westeurope&#34;</span>
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># Here we define the storage account that will be used by the function. Any azure function needs a storage account. https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/storage_account
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_storage_account&#34;</span> <span style=color:#e6db74>&#34;st_func&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span>                            = <span style=color:#e6db74>&#34;stfuncpythondeployment&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>resource_group_name</span>             = <span style=color:#a6e22e>azurerm_resource_group</span>.<span style=color:#a6e22e>rg</span>.<span style=color:#a6e22e>name</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>location</span>                        = <span style=color:#a6e22e>azurerm_resource_group</span>.<span style=color:#a6e22e>rg</span>.<span style=color:#a6e22e>location</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>account_tier</span>                    = <span style=color:#e6db74>&#34;Standard&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>account_replication_type</span>        = <span style=color:#e6db74>&#34;LRS&#34;</span>
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># Here we define the service plan that will be used by the function. The service plan defines the location, the operating system and the pricing tier. https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/service_plan
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_service_plan&#34;</span> <span style=color:#e6db74>&#34;func_plan&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span>                = <span style=color:#e6db74>&#34;plan-func-python-deployment-test&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>location</span>            = <span style=color:#a6e22e>azurerm_resource_group</span>.<span style=color:#a6e22e>rg</span>.<span style=color:#a6e22e>location</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>resource_group_name</span> = <span style=color:#a6e22e>azurerm_resource_group</span>.<span style=color:#a6e22e>rg</span>.<span style=color:#a6e22e>name</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>os_type</span>             = <span style=color:#e6db74>&#34;Linux&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>sku_name</span>            = <span style=color:#e6db74>&#34;Y1&#34;</span>
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># Here we define the function app. The function app is the actual function that will be deployed. It is linked to the service plan and the storage account. https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/linux_function_app
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_linux_function_app&#34;</span> <span style=color:#e6db74>&#34;func&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span>                       = <span style=color:#e6db74>&#34;func-python-deployment-test&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>location</span>                   = <span style=color:#a6e22e>azurerm_resource_group</span>.<span style=color:#a6e22e>rg</span>.<span style=color:#a6e22e>location</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>resource_group_name</span>        = <span style=color:#a6e22e>azurerm_resource_group</span>.<span style=color:#a6e22e>rg</span>.<span style=color:#a6e22e>name</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>service_plan_id</span>            = <span style=color:#a6e22e>azurerm_service_plan</span>.<span style=color:#a6e22e>func_plan</span>.<span style=color:#a6e22e>id</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>storage_account_name</span>       = <span style=color:#a6e22e>azurerm_storage_account</span>.<span style=color:#a6e22e>st_func</span>.<span style=color:#a6e22e>name</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>storage_account_access_key</span> = <span style=color:#a6e22e>azurerm_storage_account</span>.<span style=color:#a6e22e>st_func</span>.<span style=color:#a6e22e>primary_access_key</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>app_settings</span> = {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>AzureWebJobsFeatureFlags</span> = <span style=color:#e6db74>&#34;EnableWorkerIndexing&#34;</span><span style=color:#75715e> # Here is the reason why you need this value: https://learn.microsoft.com/en-us/azure/azure-functions/create-first-function-vs-code-python?pivots=python-mode-decorators#update-app-settings
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>FUNCTIONS_WORKER_RUNTIME</span> = <span style=color:#e6db74>&#34;python&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>site_config</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>application_stack</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>python_version</span> = <span style=color:#e6db74>&#34;3.10&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=create-azure-function-python-application>Create azure function python application</h2><p>You can create azure function in a different ways. Here is the Microsoft documentation about how to do this in <a href="https://learn.microsoft.com/en-us/azure/azure-functions/create-first-function-vs-code-python?pivots=python-mode-decorators" target=_blank rel=noopener>Visual Studio Code</a> or <a href="https://learn.microsoft.com/en-us/azure/azure-functions/create-first-function-cli-python?tabs=azure-cli%2Cbash&amp;pivots=python-mode-decorators" target=_blank rel=noopener>Command Line</a>. I will use the simplified function that is created by Visual Studio Code. You can find the source code on my <a href=https://github.com/lAnubisl/AzureFunctionPythonLinuxConsumptionZipDeployment/tree/main/azure_function target=_blank rel=noopener>github</a>. Here is the function HTTP trigger code.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@app.route</span>(route<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Health&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>Health</span>(req: func<span style=color:#f92672>.</span>HttpRequest) <span style=color:#f92672>-&gt;</span> func<span style=color:#f92672>.</span>HttpResponse:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> func<span style=color:#f92672>.</span>HttpResponse(<span style=color:#e6db74>&#34;Healthy&#34;</span>, status_code<span style=color:#f92672>=</span><span style=color:#ae81ff>200</span>)
</span></span></code></pre></div><h2 id=deployment>Deployment</h2><p>There are <a href=https://learn.microsoft.com/en-us/azure/azure-functions/functions-deployment-technologies target=_blank rel=noopener>many ways</a> you can use to deploy your azure funtion. However, for Linux Consumption Plan there are only two ways: you can use <a href=https://learn.microsoft.com/en-us/azure/azure-functions/functions-deployment-technologies#external-package-url target=_blank rel=noopener>External package URL</a> or <a href=https://learn.microsoft.com/en-us/azure/azure-functions/functions-deployment-technologies#zip-deploy target=_blank rel=noopener>Zip deploy</a>.
<img src=/images/azure-function-serverless-deployment-dotnet/deployment_options.png alt>
I will use Zip deploy option for this example.</p><p>All you need is to create deployment package. You can find more information about deployment package structure <a href=https://learn.microsoft.com/en-us/azure/azure-functions/deployment-zip-push#deployment-zip-file-requirements target=_blank rel=noopener>here</a>. In short, you need to create a zip file with all the files from the publish folder but not the publish folder itself!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cd azure_function
</span></span><span style=display:flex><span>zip -r ../publish.zip .
</span></span><span style=display:flex><span>cd ..
</span></span></code></pre></div><p>Double check that you generate the zip file correctly. If you don&rsquo;t then you can face an issue when Azure says &lsquo;Deployment successful&rsquo; but the function app is not working.
The archive should not contain the folder with the function app it shoukd contain the files from the folder.</p><p>Here is the example of the incorrect archive structure.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>unzip -l publish.zip
</span></span><span style=display:flex><span>Archive:  publish.zip
</span></span><span style=display:flex><span>  Length      Date    Time    Name
</span></span><span style=display:flex><span>---------  ---------- -----   ----
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>0</span>  2023-06-03 12:30   azure_function/
</span></span><span style=display:flex><span>       <span style=color:#ae81ff>98</span>  2023-06-03 12:10   azure_function/.funcignore
</span></span><span style=display:flex><span>      <span style=color:#ae81ff>259</span>  2023-06-03 13:01   azure_function/function_app.py
</span></span><span style=display:flex><span>      <span style=color:#ae81ff>203</span>  2023-06-03 12:09   azure_function/requirements.txt
</span></span><span style=display:flex><span>      <span style=color:#ae81ff>288</span>  2023-06-03 12:09   azure_function/host.json
</span></span><span style=display:flex><span>      <span style=color:#ae81ff>199</span>  2023-06-03 12:13   azure_function/local.settings.json
</span></span><span style=display:flex><span>---------                     -------
</span></span><span style=display:flex><span>     <span style=color:#ae81ff>1047</span>                     <span style=color:#ae81ff>6</span> files
</span></span></code></pre></div><p>Here is the example of the correct archive structure.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ unzip -l publish.zip
</span></span><span style=display:flex><span>Archive:  publish.zip
</span></span><span style=display:flex><span>  Length      Date    Time    Name
</span></span><span style=display:flex><span>---------  ---------- -----   ----
</span></span><span style=display:flex><span>       <span style=color:#ae81ff>98</span>  2023-06-03 12:10   .funcignore
</span></span><span style=display:flex><span>      <span style=color:#ae81ff>259</span>  2023-06-03 13:01   function_app.py
</span></span><span style=display:flex><span>      <span style=color:#ae81ff>203</span>  2023-06-03 12:09   requirements.txt
</span></span><span style=display:flex><span>      <span style=color:#ae81ff>288</span>  2023-06-03 12:09   host.json
</span></span><span style=display:flex><span>      <span style=color:#ae81ff>199</span>  2023-06-03 12:13   local.settings.json
</span></span><span style=display:flex><span>---------                     -------
</span></span><span style=display:flex><span>     <span style=color:#ae81ff>1047</span>                     <span style=color:#ae81ff>5</span> files
</span></span></code></pre></div><p>Then you need to deploy the package to the function app. You can find credentials on Azure Portal or use Terraform Outputs.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># deploy the artifact to the function app. You can find credentials on Azure Portal or use Terraform Outputs.</span>
</span></span><span style=display:flex><span>DEPLOYMENT_USER<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;$func-python-deployment-test&#39;</span>
</span></span><span style=display:flex><span>DEPLOYMENT_PASSWORD<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;***************************&#39;</span>
</span></span><span style=display:flex><span>DEPLOYMENT_APP<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;func-python-deployment-test&#39;</span>
</span></span><span style=display:flex><span>CREDENTIALS<span style=color:#f92672>=</span>$DEPLOYMENT_USER:$DEPLOYMENT_PASSWORD
</span></span><span style=display:flex><span>curl -v -X POST --user $CREDENTIALS --data-binary @<span style=color:#e6db74>&#34;publish.zip&#34;</span> https://$DEPLOYMENT_APP.scm.azurewebsites.net:443/api/zipdeploy
</span></span></code></pre></div><p>After deployment you can check the logs.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -X GET --user $CREDENTIALS https://$DEPLOYMENT_APP.scm.azurewebsites.net:443/deployments
</span></span></code></pre></div><p>After successful deployment you can check that the archive is locates in the storage account of the function app inside the &lsquo;scm-releases&rsquo; container.
<img src=/images/azure-function-serverless-deployment-python/deployment_package_in_storage.png alt></p><p>Another interesting thing is <a href=https://learn.microsoft.com/en-us/azure/azure-functions/functions-deployment-technologies#trigger-syncing target=_blank rel=noopener>trigger syncing</a>. The Microsoft documentation says that the <a href="https://github.com/projectkudu/kudu/wiki/Deploying-from-a-zip-file-or-url#comparison-with-zip-api:~:text=Zipdeploy%20will%20perform%20this%20synchronization%20for%20you" target=_blank rel=noopener>Zip deploy will perform this synchronization for you</a>. Hovewer, for for some reason the Python Azure function model v2 requires additional parameter to be set in the app settings. You can find more information about this parameter <a href="https://learn.microsoft.com/en-us/azure/azure-functions/create-first-function-vs-code-python?pivots=python-mode-decorators#update-app-settings" target=_blank rel=noopener>here</a>. You need to set the value of the &lsquo;AzureWebJobsFeatureFlags&rsquo; to &lsquo;EnableWorkerIndexing&rsquo;. You can do this in the Azure Portal or using Terraform (as we did in this article).</p><p>After the deployment you can check that the function is working.</p><p><img src=/images/azure-function-serverless-deployment-python/functions_list.png alt></p><h2 id=conclusion>Conclusion</h2><p>Zip Deploy can be used to deploy python azure function to Linux Consumption Plan. It is simple and does not require additional software installed on the CD runner or shared credentials like <a href="https://learn.microsoft.com/en-us/azure/active-directory/develop/app-objects-and-service-principals?tabs=browser" target=_blank rel=noopener>Azure Service Principal</a>.</p></div><h2>Comments</h2><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//byalexblog.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></main><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-44968940-4","auto"),ga("send","pageview"))</script></body></html>