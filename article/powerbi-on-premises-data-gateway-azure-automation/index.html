<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.146.5"><meta name=viewport content="width=device-width,initial-scale=1"><title>Automate Power BI On-Premises Data Gateway (Self-Hosted) on Azure VM &#183; by Alex Code blog</title>
<meta name=keywords content="powerbi,powerbi-gateway,azzure,automation,terraform"><meta name=description content="How to automate the installation of On-Premises Data Gateway on Azure VM"><link type=text/css rel=stylesheet href=https://byalexblog.net/css/print.css media=print><link type=text/css rel=stylesheet href=https://byalexblog.net/css/poole.css><link type=text/css rel=stylesheet href=https://byalexblog.net/css/syntax.css><link type=text/css rel=stylesheet href=https://byalexblog.net/css/hyde.css><link type=text/css rel=stylesheet href=https://byalexblog.net/css/vs_theme_style.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png></head><body><aside class=sidebar><div class=container><div class=sidebar-about><a href=https://byalexblog.net/><h1>by Alex Code blog</h1></a><p class=lead>Smart thoughts... and not very smart too!</p></div><nav><ul class=sidebar-nav><li><a href=https://byalexblog.net/>Home</a></li><li><a href=https://byalexblog.net/article>Articles</a></li><li><a href=https://github.com/lanubisl target=_blank>Github</a></li><li><a href=https://www.linkedin.com/in/panfilenok target=_blank>LinkedIn</a></li></ul></nav><p>&copy; 2025. All rights reserved.</p></div></aside><main class="content container"><div class=post><h1>Automate Power BI On-Premises Data Gateway (Self-Hosted) on Azure VM</h1><time datetime=2025-04-05T06:39:47Z class=post-date>Sat, Apr 5, 2025</time><h2 id=background-and-challenges>Background and Challenges</h2><p>Microsoft Power BI Pro (the cloud service) often needs to query data that resides in secure, private networks. In our scenario, the data source is an Azure SQL Database deployed inside a private Azure Virtual Network with no public internet access. By default, Power BI’s cloud service cannot reach such isolated data sources directly​. <a href=https://learn.microsoft.com/en-us/power-bi/guidance/powerbi-implementation-planning-data-gateways target=_blank rel=noopener>learn.microsoft.com</a>.
<img src=/images/powerbi-on-premises-data-gateway-azure-automation/no-connectivity-1.png alt>
Enabling broad access (for example, by turning on “Allow Azure Services…” on the SQL firewall) would expose the database to all Azure services and is not recommended for production​. Therefore, we need a solution that preserves security (no public endpoints) while allowing Power BI to query the data.</p><p>Key challenges and requirements include:</p><ul><li><strong>No Public Exposure</strong>: The Azure SQL must remain inaccessible from the public internet (e.g. using Private Endpoints and disabling public network access)​</li><li><strong>Power BI Service Connectivity</strong>: Power BI (a SaaS cloud service) must be able to reach the database through a secure channel despite the network isolation.</li><li><strong>Security First</strong>: All data transit should occur over secure, internal channels (e.g. Azure backbone)​, with minimal attack surface (no inbound ports opened to random addresses).</li><li><strong>Automation</strong>: The entire setup should be deployable and repeatable.</li><li><strong>Deployment and Recovery</strong>: The solution should account for high availability, easy re-deployment (e.g. updates or changes), and disaster recovery (e.g. if the gateway VM or service fails, how to recover access).</li></ul><p>Microsoft provides two solutions to this problem:</p><ol><li><strong>On-Premises Data Gateway (Self-Hosted)</strong>: running the standard Power BI Enterprise Gateway on a VM inside the VNet.</li><li><strong>Virtual Network Data Gateway (Managed)</strong>: using Power BI’s VNet integration feature (managed gateway service injected into your VNet, available with Premium capacities).</li></ol><p>In this article, we will focus on the first solution, which is more flexible and allows for a wider range of data sources.</p><h2 id=azure-vm-with-on-premises-data-gateway-self-hosted>Azure VM with On-Premises Data Gateway (Self-Hosted)</h2><p>In this pattern, we deploy an On-Premises Data Gateway (standard mode) on a Windows VM that resides inside the same private VNet as the Azure SQL Database (or one that has network access to it). Despite the name, this gateway can be used not only for on-premises networks but also for private cloud networks​ <a href=https://learn.microsoft.com/en-us/power-bi/guidance/powerbi-implementation-planning-data-gateways target=_blank rel=noopener>learn.microsoft.com</a>. The gateway acts as a bridge between Power BI cloud and the private database:
<img src=/images/powerbi-on-premises-data-gateway-azure-automation/gateway-connectivity.png alt>
This approach keeps the database fully isolated. The only “pipe” into the VNet is the gateway’s outgoing relay to Power BI. Azure SQL accepts connections only from within the VNet (the gateway VM’s IP). All data in transit is encrypted via TLS. We avoid opening any broad firewall rules (like “Allow Azure services…”) which would otherwise allow unknown Azure IPs​. We also avoid exposing a public IP for the database at all. DNS resolution of the database name is handled via the private DNS zone so that even the gateway uses the internal address.</p><h2 id=automation>Automation</h2><h3 id=install-the-on-premises-data-gateway-on-azure-vm>Install the On-Premises Data Gateway on Azure VM</h3><p>There are two options to install the On-Premises Data Gateway on the Azure VM:</p><ol><li>Using the <a href=https://learn.microsoft.com/en-us/data-integration/gateway/service-gateway-monthly-updates target=_blank rel=noopener>Installer executable</a></li><li>Using the <a href="https://learn.microsoft.com/en-us/powershell/module/datagateway/?view=datagateway-ps" target=_blank rel=noopener>DataGateway PowerShell module</a> (Public Preview as of 2025-04-05)</li></ol><p>The first option is more straightforward, however, it requires manual installation and configuration of the gateway. The second option allows for a more automated approach, but it requires additional setup and configuration.</p><h4 id=using-the-datagateway-powershell-module>Using the DataGateway PowerShell module</h4><p>This approach includes the installation of the <a href="https://learn.microsoft.com/en-us/powershell/gateway/overview?view=datagateway-ps" target=_blank rel=noopener>PowerShell Cmdlets for On-premises data gateway management</a> which requires the <a href="https://learn.microsoft.com/en-us/powershell/scripting/install/installing-powershell-on-windows?view=powershell-7.5&amp;viewFallbackFrom=powershell-7&amp;WT.mc_id=THOMASMAURER-blog-thmaure" target=_blank rel=noopener>PowerShell 7.0.6 or higher</a></p><p><a href="https://learn.microsoft.com/en-us/powershell/scripting/install/installing-powershell-on-windows?view=powershell-7.5&amp;WT.mc_id=THOMASMAURER-blog-thmaure#install-powershell-using-winget-recommended" target=_blank rel=noopener>Microsoft recommends installing the PowerShell using WinGet</a>. However, <a href=https://github.com/PowerShell/PowerShell/blob/master/tools/install-powershell.ps1-README.md target=_blank rel=noopener>this method also works well</a>:</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#9ca0b0;font-style:italic># Download PowerShell 7</span>
</span></span><span style=display:flex><span><span style=color:#04a5e5>Invoke-Expression</span> -Command <span style=color:#40a02b>&#34;&amp;{</span>$(<span style=color:#04a5e5>Invoke-RestMethod</span> https<span style=color:#d20f39>:</span>//aka.ms/<span style=color:#04a5e5>install-powershell</span>.ps1)<span style=color:#40a02b>} -UseMSI -Quiet&#34;</span>
</span></span><span style=display:flex><span>.<span style=color:#40a02b>&#34;C:\Program Files\PowerShell\7\pwsh.exe&#34;</span>
</span></span></code></pre></div><p>After installing PowerShell, we can install the DataGateway module using the following command:</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#9ca0b0;font-style:italic># Install DataGateway module</span>
</span></span><span style=display:flex><span><span style=color:#04a5e5>Start-Process</span> pwsh -ArgumentList <span style=color:#40a02b>&#34;-Command Install-Module -Name DataGateway -Force&#34;</span> -Wait
</span></span></code></pre></div><p>After installing the DataGateway module, we need to do the following:</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#9ca0b0;font-style:italic># Connect to the Data Gateway service (https://learn.microsoft.com/en-us/powershell/module/datagateway.profile/connect-datagatewayserviceaccount?view=datagateway-ps)</span>
</span></span><span style=display:flex><span><span style=color:#04a5e5>Connect-DataGatewayServiceAccount</span> `
</span></span><span style=display:flex><span>    -ApplicationId <span style=color:#40a02b>&#34;YOUR APPLICATION ID&#34;</span> `
</span></span><span style=display:flex><span>    -Tenant <span style=color:#40a02b>&#34;YOUR TENANT ID&#34;</span> `
</span></span><span style=display:flex><span>    -ClientSecret <span style=color:#40a02b>&#34;YOUR SERVICE PRINCIPAL SECRET&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#9ca0b0;font-style:italic># Install the Data Gateway (https://learn.microsoft.com/en-us/powershell/module/datagateway/install-datagateway?view=datagateway-ps)</span>
</span></span><span style=display:flex><span><span style=color:#04a5e5>Install-DataGateway</span> -AcceptConditions
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#9ca0b0;font-style:italic># Create a cluster(https://learn.microsoft.com/en-us/powershell/module/datagateway/add-datagatewaycluster?view=datagateway-ps)</span>
</span></span><span style=display:flex><span><span style=color:#dc8a78>$recoveryKey</span> = <span style=color:#04a5e5>ConvertTo-SecureString</span> <span style=color:#40a02b>&#34;YOUR RECOVERY KEY HERE&#34;</span> `
</span></span><span style=display:flex><span>    -AsPlainText `
</span></span><span style=display:flex><span>    -Force;
</span></span><span style=display:flex><span><span style=color:#dc8a78>$cluster</span> = <span style=color:#04a5e5>Add-DataGatewayCluster</span> `
</span></span><span style=display:flex><span>    -Name <span style=color:#40a02b>&#34;YOUR CLUSTER NAME HERE&#34;</span> `
</span></span><span style=display:flex><span>    -RecoveryKey <span style=color:#dc8a78>$recoveryKey</span>
</span></span></code></pre></div><h2 id=recovery--re-deployment>Recovery / Re-Deployment</h2><p>If you look at the <a href="https://learn.microsoft.com/en-us/powershell/module/datagateway/?view=datagateway-ps" target=_blank rel=noopener>DataGateway module documentation</a>, you will not find any command to add newly installed gateways to the cluster (as of 2025-04-05). However, the <strong><a href=https://powerbi.microsoft.com/en-in/blog/on-premises-data-gateway-october-2023-release/ target=_blank rel=noopener>Add-DataGatewayClusterMember command was announced in October 2023</a></strong> and the Microsoft documentation is not updated yet (2025-04-05).</p><p>The <strong>Add-DataGatewayClusterMember</strong> will register a new gateway to the local machine and add it as a new member to the gateway cluster you specify. The recovery key and gateway cluster id in the command must pertain to the primary gateway node. In addition, the gateway must already be installed, but not registered to the local machine. The command takes three inputs:</p><ul><li><strong>GatewayName</strong> (string): This is the name of the gateway that will be created on the local machine and added as a member to the cluster. It cannot conflict with any existing gateways on the same tenant.</li><li><strong>RecoveryKey</strong> (Secure string): The recovery key of the primary gateway member in the existing cluster. The recovery key is used by the gateway to encrypt/decrypt on-prem credentials. This is also required to restore the gateway or add a new member to the gateway cluster.</li><li><strong>GatewayClusterId</strong> (Guid): The gateway object id of the primary gateway node.</li></ul><h2 id=terraform>Terraform</h2><p>Having all the above in mind, we can now create a powershell script to automate the installation of the On-Premises Data Gateway on the Azure VM.</p><p>Here is a sample Terraform code to attach the installation script to the VM and run it after the VM is created:</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#8839ef>resource</span> <span style=color:#40a02b>&#34;azurerm_windows_virtual_machine&#34; &#34;vm&#34;</span> {
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8839ef>data</span> <span style=color:#40a02b>&#34;template_file&#34; &#34;ps5script&#34;</span> {
</span></span><span style=display:flex><span>  template <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>file</span>(<span style=color:#40a02b>&#34;${path.module}/installation-scripts/ps5script.ps1&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8839ef>resource</span> <span style=color:#40a02b>&#34;azurerm_virtual_machine_extension&#34; &#34;script&#34;</span> {
</span></span><span style=display:flex><span>  name                 <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#40a02b>&#34;install_data_gateway&#34;</span>
</span></span><span style=display:flex><span>  virtual_machine_id   <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>azurerm_windows_virtual_machine</span>.<span style=color:#8839ef>vm</span>.<span style=color:#8839ef>id</span>
</span></span><span style=display:flex><span>  publisher            <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#40a02b>&#34;Microsoft.Compute&#34;</span>
</span></span><span style=display:flex><span>  type                 <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#40a02b>&#34;CustomScriptExtension&#34;</span>
</span></span><span style=display:flex><span>  type_handler_version <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#40a02b>&#34;1.9&#34;</span>
</span></span><span style=display:flex><span>  protected_settings   <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#d20f39>&lt;&lt;</span><span style=color:#8839ef>SETTINGS</span>
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#40a02b>&#34;commandToExecute&#34;: &#34;powershell -command \&#34;[System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String(&#39;${base64encode(data.template_file.ps5script.rendered)}&#39;)) | Out-File -filepath ps5script.ps1\&#34; &amp;&amp; powershell -ExecutionPolicy Unrestricted -File ps5script.ps1 &gt; ps5script.log&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#8839ef>SETTINGS</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=conclusion>Conclusion</h2><p>In this article, we have discussed how to set up an On-Premises Data Gateway (Self-Hosted) on an Azure VM using DataGateway module. We have also discussed how to automate the installation and configuration of the gateway using PowerShell and Terraform. This solution allows us to securely connect Power BI to our private Azure SQL Database without exposing it to the public internet.
This approach also allows for easy re-deployment and disaster recovery in case of VM or service failures. The use of the DataGateway PowerShell module allows for a more automated approach to managing the gateway, while the Terraform code allows for easy deployment and management of the Azure resources.</p></div><h2>Comments</h2><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//byalexblog.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></main></body></html>