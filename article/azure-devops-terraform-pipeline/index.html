<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.146.5"><meta name=viewport content="width=device-width,initial-scale=1"><title>Azure DevOps Terraform Pipeline &#183; by Alex Code blog</title>
<meta name=keywords content="azure-devops,terraform,iac,azure,devops"><meta name=description content="How to provision cloud infrastructure with Terraform and Azure DevOps."><link type=text/css rel=stylesheet href=https://blog.byalex.dev/css/print.css media=print><link type=text/css rel=stylesheet href=https://blog.byalex.dev/css/poole.css><link type=text/css rel=stylesheet href=https://blog.byalex.dev/css/syntax.css><link type=text/css rel=stylesheet href=https://blog.byalex.dev/css/hyde.css><link type=text/css rel=stylesheet href=https://blog.byalex.dev/css/vs_theme_style.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png></head><body><aside class=sidebar><div class=container><div class=sidebar-about><a href=https://blog.byalex.dev/><h1>by Alex Code blog</h1></a><p class=lead>Smart thoughts... and not very smart too!</p></div><nav><ul class=sidebar-nav><li><a href=https://blog.byalex.dev/>Home</a></li><li><a href=https://blog.byalex.dev/article>Articles</a></li><li><a href=https://github.com/lanubisl target=_blank>Github</a></li><li><a href=https://www.linkedin.com/in/panfilenok target=_blank>LinkedIn</a></li></ul></nav><p>&copy; 2025. All rights reserved.</p></div></aside><main class="content container"><div class=post><h1>Azure DevOps Terraform Pipeline</h1><time datetime=2024-06-22T07:38:40Z class=post-date>Sat, Jun 22, 2024</time><p><img src=/images/azure-devops-terraform-pipeline/logo.png alt></p><p>I was recently working on a project that required me to create a Terraform pipeline in Azure DevOps. I had never done this before, so I had to do some research to figure out how to set it up. In this article, I will share the final pipeline that I created, as well as some of the resources that I found helpful along the way.</p><h2 id=preconditions>Preconditions</h2><ul><li>I will use <strong>&lsquo;ubuntu-latest&rsquo;</strong> as the agent pool for this pipeline. Because I use Ubuntu in other CI/CD tool like GitHub Actions and GitLab CI/CD, I am familiar with the commands and tools available in the Ubuntu environment. If you are using a different agent pool, you may need to adjust the commands accordingly.</li><li>Terraform installation script can be found <a href=https://developer.hashicorp.com/terraform/tutorials/aws-get-started/install-cli#install-terraform target=_blank rel=noopener>here</a>. I will use this script to install Terraform on the agent machine.</li><li>My Azure DevOps uses <a href="https://learn.microsoft.com/en-us/azure/devops/pipelines/library/service-endpoints?view=azure-devops&amp;tabs=yaml" target=_blank rel=noopener>Service Connection</a> to authenticate with Azure. In my case the Service Connection uses <a href=https://learn.microsoft.com/en-us/entra/workload-id/workload-identity-federation target=_blank rel=noopener>Identity Federation</a> as the authentication method.</li><li>Terraform pipeline steps from <a href="https://marketplace.visualstudio.com/search?term=terraform&amp;target=AzureDevOps&amp;category=Azure%20Pipelines&amp;sortBy=Relevance" target=_blank rel=noopener>marketplace</a> are not available for my use case.</li></ul><h2 id=terraform-pipeline>Terraform Pipeline</h2><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8839ef>stages</span>:
</span></span><span style=display:flex><span>  - <span style=color:#8839ef>stage</span>: Terraform
</span></span><span style=display:flex><span>    <span style=color:#8839ef>jobs</span>:
</span></span><span style=display:flex><span>    - <span style=color:#8839ef>job</span>: Terraform
</span></span><span style=display:flex><span>      <span style=color:#8839ef>pool</span>:
</span></span><span style=display:flex><span>        <span style=color:#8839ef>vmImage</span>: <span style=color:#40a02b>&#39;ubuntu-latest&#39;</span>
</span></span><span style=display:flex><span>      <span style=color:#8839ef>steps</span>:
</span></span><span style=display:flex><span>      - <span style=color:#8839ef>task</span>: CmdLine@2
</span></span><span style=display:flex><span>        <span style=color:#8839ef>displayName</span>: <span style=color:#40a02b>&#39;Terraform Install&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#8839ef>inputs</span>:
</span></span><span style=display:flex><span>          <span style=color:#8839ef>script</span>: |
</span></span><span style=display:flex><span><span style=color:#9ca0b0;font-style:italic># https://developer.hashicorp.com/terraform/tutorials/aws-get-started/install-cli#install-terraform</span>
</span></span><span style=display:flex><span>            sudo apt-get update &amp;&amp; sudo apt-get install -y gnupg software-properties-common
</span></span><span style=display:flex><span>            wget -O- https://apt.releases.hashicorp.com/gpg | \
</span></span><span style=display:flex><span>              gpg --dearmor | \
</span></span><span style=display:flex><span>              sudo tee /usr/share/keyrings/hashicorp-archive-keyring.gpg &gt; /dev/null
</span></span><span style=display:flex><span>            echo &#34;deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] \
</span></span><span style=display:flex><span>              https://apt.releases.hashicorp.com $(lsb_release -cs) main&#34; | \
</span></span><span style=display:flex><span>              sudo tee /etc/apt/sources.list.d/hashicorp.list
</span></span><span style=display:flex><span>            sudo apt update
</span></span><span style=display:flex><span>            sudo apt-get install terraform
</span></span><span style=display:flex><span>            terraform --version
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      - <span style=color:#8839ef>task</span>: AzureCLI@2
</span></span><span style=display:flex><span>        <span style=color:#8839ef>displayName</span>: <span style=color:#40a02b>&#39;Terraform Plan&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#8839ef>inputs</span>:
</span></span><span style=display:flex><span>          <span style=color:#8839ef>addSpnToEnvironment</span>: <span style=color:#fe640b>true</span>
</span></span><span style=display:flex><span>          <span style=color:#8839ef>azureSubscription</span>: MyServiceConnection
</span></span><span style=display:flex><span>          <span style=color:#8839ef>scriptType</span>: bash
</span></span><span style=display:flex><span>          <span style=color:#8839ef>scriptLocation</span>: inlineScript
</span></span><span style=display:flex><span>          <span style=color:#8839ef>workingDirectory</span>: <span style=color:#40a02b>&#39;$(System.DefaultWorkingDirectory)/infrastructure&#39;</span>
</span></span><span style=display:flex><span>          <span style=color:#8839ef>inlineScript</span>: |
</span></span><span style=display:flex><span><span style=color:#9ca0b0;font-style:italic># https://devblogs.microsoft.com/devops/public-preview-of-workload-identity-federation-for-azure-pipelines/#azure-cli-task-support-for-inline-authentication</span>
</span></span><span style=display:flex><span>            export ARM_CLIENT_ID=$servicePrincipalId
</span></span><span style=display:flex><span>            export ARM_OIDC_TOKEN=$idToken
</span></span><span style=display:flex><span>            export ARM_TENANT_ID=$tenantId
</span></span><span style=display:flex><span>            export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)
</span></span><span style=display:flex><span>            export ARM_USE_OIDC=true
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            terraform init \
</span></span><span style=display:flex><span>              -var-file=&#34;./env/dev/input.tfvars&#34; \
</span></span><span style=display:flex><span>              -backend-config=&#34;./env/dev/backend.tfvars&#34;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            terraform plan \
</span></span><span style=display:flex><span>              -var-file=&#34;./env/dev/input.tfvars&#34; \
</span></span><span style=display:flex><span>              -input=false
</span></span></code></pre></div><h2 id=links>Links</h2><ul><li>Microsoft documentation: <a href="https://learn.microsoft.com/en-us/azure/devops/pipelines/tasks/reference/azure-cli-v2?view=azure-pipelines" target=_blank rel=noopener>AzureCLI@2 - Azure CLI v2 task</a> Azure CLI task documentation. In particular <strong>addSpnToEnvironment</strong> parameter that allows to get azure connection details from the service connection.</li><li>Terraform documentation: <a href=https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/guides/service_principal_oidc target=_blank rel=noopener>Azure Provider: Authenticating using a Service Principal with Open ID Connect</a></li><li>Medium article: <a href=https://medium.com/@maciej.skorupka/terraform-in-azure-devops-without-additional-tasks-8f29434e6e2 target=_blank rel=noopener>Terraform in Azure Devops without additional tasks</a></li><li>Microsoft blog post: <a href=https://devblogs.microsoft.com/devops/public-preview-of-workload-identity-federation-for-azure-pipelines/ target=_blank rel=noopener>Public preview of Workload identity federation for Azure Pipelines</a></li></ul></div><h2>Comments</h2><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//byalexblog.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></main></body></html>